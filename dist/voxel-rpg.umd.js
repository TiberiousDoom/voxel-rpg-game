(function(l,w){typeof exports=="object"&&typeof module<"u"?w(exports):typeof define=="function"&&define.amd?define(["exports"],w):(l=typeof globalThis<"u"?globalThis:l||self,w(l.VoxelRPG={}))})(this,function(l){"use strict";var w=(n=>(n.North="N",n.South="S",n.East="E",n.West="W",n.NorthEast="NE",n.NorthWest="NW",n.SouthEast="SE",n.SouthWest="SW",n))(w||{}),X=(n=>(n.Player="player",n.NPC="npc",n.Monster="monster",n.Item="item",n.Projectile="projectile",n))(X||{}),p=(n=>(n[n.Background=0]="Background",n[n.Ground=1]="Ground",n[n.Objects=2]="Objects",n[n.Walls=3]="Walls",n[n.Foreground=4]="Foreground",n))(p||{}),Q=(n=>(n.MoveUp="moveUp",n.MoveDown="moveDown",n.MoveLeft="moveLeft",n.MoveRight="moveRight",n.Sprint="sprint",n.Interact="interact",n.Attack="attack",n.Secondary="secondary",n.Cancel="cancel",n.Inventory="inventory",n.BuildMenu="buildMenu",n.Pause="pause",n.ZoomIn="zoomIn",n.ZoomOut="zoomOut",n.QuickSlot1="quickSlot1",n.QuickSlot2="quickSlot2",n.QuickSlot3="quickSlot3",n.QuickSlot4="quickSlot4",n.QuickSlot5="quickSlot5",n.QuickSlot6="quickSlot6",n.QuickSlot7="quickSlot7",n.QuickSlot8="quickSlot8",n.QuickSlot9="quickSlot9",n))(Q||{}),v=(n=>(n[n.A=0]="A",n[n.B=1]="B",n[n.X=2]="X",n[n.Y=3]="Y",n[n.LeftBumper=4]="LeftBumper",n[n.RightBumper=5]="RightBumper",n[n.LeftTrigger=6]="LeftTrigger",n[n.RightTrigger=7]="RightTrigger",n[n.Select=8]="Select",n[n.Start=9]="Start",n[n.LeftStick=10]="LeftStick",n[n.RightStick=11]="RightStick",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n))(v||{}),C=(n=>(n[n.LeftStickX=0]="LeftStickX",n[n.LeftStickY=1]="LeftStickY",n[n.RightStickX=2]="RightStickX",n[n.RightStickY=3]="RightStickY",n))(C||{}),E=(n=>(n.HUD="hud",n.Inventory="inventory",n.Build="build",n.NPC="npc",n.Settings="settings",n.Pause="pause",n))(E||{});class k{static instance=null;subscribers=new Map;eventQueue=[];isProcessing=!1;constructor(){}static getInstance(){return k.instance||(k.instance=new k),k.instance}static reset(){k.instance&&(k.instance.subscribers.clear(),k.instance.eventQueue=[],k.instance.isProcessing=!1),k.instance=null}on(e,t,i=0){return this.subscribe(e,t,!1,i)}once(e,t,i=0){return this.subscribe(e,t,!0,i)}emit(e,t){const i=this.subscribers.get(e);if(!i||i.length===0)return;const s=[...i].sort((a,r)=>r.priority-a.priority),o=[];for(const a of s)try{a.handler(t),a.once&&o.push(a)}catch(r){console.error(`Error in event handler for "${e}":`,r)}for(const a of o){const r=i.indexOf(a);r!==-1&&i.splice(r,1)}}queue(e,t){this.eventQueue.push({event:e,payload:t})}processQueue(){if(!this.isProcessing){for(this.isProcessing=!0;this.eventQueue.length>0;){const e=this.eventQueue.shift();e&&this.emit(e.event,e.payload)}this.isProcessing=!1}}off(e){this.subscribers.delete(e)}subscriberCount(e){return this.subscribers.get(e)?.length??0}subscribe(e,t,i,s){this.subscribers.has(e)||this.subscribers.set(e,[]);const o={handler:t,once:i,priority:s};return this.subscribers.get(e).push(o),()=>{const a=this.subscribers.get(e);if(a){const r=a.indexOf(o);r!==-1&&a.splice(r,1)}}}}const h=()=>k.getInstance(),Re={tileSize:32,regionSize:64,loadDistance:2,unloadDistance:3,dayLengthSeconds:600};class M{static instance=null;config;systems=new Map;systemOrder=[];eventBus;isRunning=!1;isPaused=!1;lastFrameTime=0;accumulatedTime=0;fixedTimeStep=1/60;gameTime={totalSeconds:0,deltaTime:0,gameHour:6,gameDay:1,isPaused:!1};animationFrameId=null;constructor(e={}){this.config={...Re,...e},this.eventBus=h()}static getInstance(e){return M.instance||(M.instance=new M(e)),M.instance}static reset(){M.instance&&(M.instance.stop(),M.instance.systems.clear(),M.instance.systemOrder=[]),M.instance=null,k.reset()}getConfig(){return this.config}getGameTime(){return this.gameTime}registerSystem(e,t){if(this.systems.has(e.name)){console.warn(`System "${e.name}" is already registered. Skipping.`);return}this.systems.set(e.name,e),t!==void 0?this.systemOrder.splice(t,0,e.name):this.systemOrder.push(e.name)}unregisterSystem(e){const t=this.systems.get(e);t&&(t.destroy?.(),this.systems.delete(e),this.systemOrder=this.systemOrder.filter(i=>i!==e))}getSystem(e){return this.systems.get(e)}async initialize(){console.log("[GameEngine] Initializing systems...");for(const e of this.systemOrder){const t=this.systems.get(e);t?.initialize&&(console.log(`[GameEngine] Initializing ${e}...`),await t.initialize())}console.log("[GameEngine] All systems initialized.")}start(){if(this.isRunning){console.warn("[GameEngine] Game loop is already running.");return}console.log("[GameEngine] Starting game loop..."),this.isRunning=!0,this.lastFrameTime=performance.now(),this.eventBus.emit("game:started",{}),this.loop()}stop(){this.isRunning&&(console.log("[GameEngine] Stopping game loop..."),this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.eventBus.emit("game:quit",{}))}pause(){this.isPaused||(this.isPaused=!0,this.gameTime.isPaused=!0,this.eventBus.emit("game:paused",{}),this.eventBus.emit("time:paused",{}))}resume(){this.isPaused&&(this.isPaused=!1,this.gameTime.isPaused=!1,this.lastFrameTime=performance.now(),this.eventBus.emit("game:resumed",{}),this.eventBus.emit("time:resumed",{}))}togglePause(){this.isPaused?this.resume():this.pause()}isGameRunning(){return this.isRunning}isGamePaused(){return this.isPaused}loop=()=>{if(!this.isRunning)return;const e=performance.now(),t=Math.min((e-this.lastFrameTime)/1e3,.1);if(this.lastFrameTime=e,this.gameTime.deltaTime=t,!this.isPaused){for(this.gameTime.totalSeconds+=t,this.updateGameClock(t),this.eventBus.processQueue(),this.accumulatedTime+=t;this.accumulatedTime>=this.fixedTimeStep;)this.fixedUpdate(this.fixedTimeStep),this.accumulatedTime-=this.fixedTimeStep;this.update(t),this.lateUpdate(t)}this.animationFrameId=requestAnimationFrame(this.loop)};updateGameClock(e){const t=this.config.dayLengthSeconds/24,i=e/t,s=Math.floor(this.gameTime.gameHour);this.gameTime.gameHour+=i;const o=Math.floor(this.gameTime.gameHour);o!==s&&o<24&&this.eventBus.emit("time:hourChanged",{hour:o,day:this.gameTime.gameDay}),this.gameTime.gameHour>=24&&(this.gameTime.gameHour-=24,this.gameTime.gameDay+=1,this.eventBus.emit("time:dayChanged",{day:this.gameTime.gameDay}),this.eventBus.emit("time:hourChanged",{hour:Math.floor(this.gameTime.gameHour),day:this.gameTime.gameDay}))}fixedUpdate(e){for(const t of this.systemOrder)this.systems.get(t)?.fixedUpdate?.(e,this.gameTime)}update(e){for(const t of this.systemOrder)this.systems.get(t)?.update?.(e,this.gameTime)}lateUpdate(e){for(const t of this.systemOrder)this.systems.get(t)?.lateUpdate?.(e,this.gameTime)}}const Y=n=>M.getInstance(n),f=(n,e,t,i={})=>({id:n,name:e,layer:t,walkable:i.walkable??!0,hardness:i.hardness??1,transparent:i.transparent??!0,drops:i.drops??[],autotileGroup:i.autotileGroup??null,buildRequirements:i.buildRequirements??[]});class x{static instance=null;tiles=new Map;constructor(){this.registerDefaultTiles()}static getInstance(){return x.instance||(x.instance=new x),x.instance}static reset(){x.instance=null}register(e){this.tiles.has(e.id)&&console.warn(`Tile type "${e.id}" is already registered. Overwriting.`),this.tiles.set(e.id,e)}get(e){return this.tiles.get(e)}has(e){return this.tiles.has(e)}getAll(){return Array.from(this.tiles.values())}getByLayer(e){return this.getAll().filter(t=>t.layer===e)}getByAutotileGroup(e){return this.getAll().filter(t=>t.autotileGroup===e)}registerDefaultTiles(){this.register(f("grass","Grass",p.Ground,{autotileGroup:"grass",drops:[{resourceId:"fiber",minAmount:0,maxAmount:1,chance:.1}]})),this.register(f("dirt","Dirt",p.Ground,{autotileGroup:"dirt",hardness:.8})),this.register(f("sand","Sand",p.Ground,{autotileGroup:"sand",hardness:.5})),this.register(f("water","Water",p.Ground,{walkable:!1,autotileGroup:"water",hardness:-1})),this.register(f("deep_water","Deep Water",p.Ground,{walkable:!1,autotileGroup:"water",hardness:-1})),this.register(f("stone_floor","Stone Floor",p.Ground,{autotileGroup:"stone",hardness:2,drops:[{resourceId:"stone",minAmount:1,maxAmount:2,chance:.5}]})),this.register(f("wooden_floor","Wooden Floor",p.Ground,{autotileGroup:"wood_floor",hardness:1,buildRequirements:[{resourceId:"wood",amount:2}],drops:[{resourceId:"wood",minAmount:1,maxAmount:2,chance:.8}]})),this.register(f("stone_path","Stone Path",p.Ground,{autotileGroup:"stone_path",hardness:1.5,buildRequirements:[{resourceId:"stone",amount:2}],drops:[{resourceId:"stone",minAmount:1,maxAmount:2,chance:.8}]})),this.register(f("tree","Tree",p.Objects,{walkable:!1,hardness:3,drops:[{resourceId:"wood",minAmount:3,maxAmount:6,chance:1},{resourceId:"stick",minAmount:1,maxAmount:3,chance:.5}]})),this.register(f("rock","Rock",p.Objects,{walkable:!1,hardness:4,drops:[{resourceId:"stone",minAmount:2,maxAmount:5,chance:1},{resourceId:"flint",minAmount:0,maxAmount:1,chance:.2}]})),this.register(f("iron_ore","Iron Ore",p.Objects,{walkable:!1,hardness:5,drops:[{resourceId:"iron_ore",minAmount:1,maxAmount:3,chance:1},{resourceId:"stone",minAmount:1,maxAmount:2,chance:.5}]})),this.register(f("bush","Bush",p.Objects,{walkable:!0,hardness:.5,drops:[{resourceId:"fiber",minAmount:1,maxAmount:2,chance:.8},{resourceId:"berries",minAmount:0,maxAmount:2,chance:.3}]})),this.register(f("chest","Chest",p.Objects,{walkable:!1,hardness:1,buildRequirements:[{resourceId:"wood",amount:15}]})),this.register(f("workbench","Workbench",p.Objects,{walkable:!1,hardness:1.5,buildRequirements:[{resourceId:"wood",amount:20}]})),this.register(f("campfire","Campfire",p.Objects,{walkable:!1,hardness:1,buildRequirements:[{resourceId:"wood",amount:5},{resourceId:"stone",amount:3}]})),this.register(f("bed","Bed",p.Objects,{walkable:!1,hardness:1,buildRequirements:[{resourceId:"wood",amount:10},{resourceId:"fiber",amount:5}]})),this.register(f("wooden_wall","Wooden Wall",p.Walls,{walkable:!1,transparent:!1,autotileGroup:"wood_wall",hardness:2,buildRequirements:[{resourceId:"wood",amount:5}],drops:[{resourceId:"wood",minAmount:2,maxAmount:4,chance:.9}]})),this.register(f("stone_wall","Stone Wall",p.Walls,{walkable:!1,transparent:!1,autotileGroup:"stone_wall",hardness:4,buildRequirements:[{resourceId:"stone",amount:8}],drops:[{resourceId:"stone",minAmount:3,maxAmount:6,chance:.9}]})),this.register(f("roof_wood","Wooden Roof",p.Foreground,{walkable:!0,transparent:!1,autotileGroup:"roof_wood",hardness:1,buildRequirements:[{resourceId:"wood",amount:3}]}))}}const A=()=>x.getInstance(),B=4,O=(n,e,t)=>`${n},${e},${t}`;class Z{name="TilemapManager";tiles=new Map;tileRegistry;pendingChanges=[];changeHistory=[];maxHistorySize=1e3;constructor(){this.tileRegistry=A()}initialize(){console.log("[TilemapManager] Initialized")}update(e,t){this.processPendingChanges()}setTile(e,t,i,s,o=0){if(!this.tileRegistry.get(s))return console.warn(`[TilemapManager] Unknown tile type: ${s}`),!1;const r=O(e,t,i),u=this.tiles.get(r)?.typeId??null,d={typeId:s,layer:i,position:{x:e,y:t},variant:o};return this.tiles.set(r,d),this.pendingChanges.push({position:{x:e,y:t},layer:i,oldTypeId:u,newTypeId:s,timestamp:Date.now()}),!0}removeTile(e,t,i){const s=O(e,t,i),o=this.tiles.get(s);return o?(this.tiles.delete(s),this.pendingChanges.push({position:{x:e,y:t},layer:i,oldTypeId:o.typeId,newTypeId:null,timestamp:Date.now()}),o):null}getTile(e,t,i){return this.tiles.get(O(e,t,i))}getTileType(e,t,i){const s=this.getTile(e,t,i);return s?this.tileRegistry.get(s.typeId):void 0}hasTile(e,t){for(let i=0;i<=B;i++)if(this.tiles.has(O(e,t,i)))return!0;return!1}isWalkable(e,t){for(let o=0;o<=B;o++){const a=this.getTile(e,t,o);if(a){const r=this.tileRegistry.get(a.typeId);if(r&&!r.walkable)return!1}}const i=this.getTile(e,t,p.Ground);return i?this.tileRegistry.get(i.typeId)?.walkable??!1:!1}isTransparent(e,t){for(let i=0;i<=B;i++){const s=this.getTile(e,t,i);if(s){const o=this.tileRegistry.get(s.typeId);if(o&&!o.transparent)return!1}}return!0}getTilesInRegion(e,t){const i=[];for(let s=e.x;s<e.x+e.width;s++)for(let o=e.y;o<e.y+e.height;o++)if(t!==void 0){const a=this.getTile(s,o,t);a&&i.push(a)}else for(let a=0;a<=B;a++){const r=this.getTile(s,o,a);r&&i.push(r)}return i}getTilesAt(e,t){const i=[];for(let s=0;s<=B;s++){const o=this.getTile(e,t,s);o&&i.push(o)}return i}getNeighbors4(e,t,i){return{north:this.getTile(e,t-1,i),south:this.getTile(e,t+1,i),east:this.getTile(e+1,t,i),west:this.getTile(e-1,t,i)}}getNeighbors8(e,t,i){return{north:this.getTile(e,t-1,i),south:this.getTile(e,t+1,i),east:this.getTile(e+1,t,i),west:this.getTile(e-1,t,i),northEast:this.getTile(e+1,t-1,i),northWest:this.getTile(e-1,t-1,i),southEast:this.getTile(e+1,t+1,i),southWest:this.getTile(e-1,t+1,i)}}clear(){this.tiles.clear(),this.pendingChanges=[]}getTileCount(){return this.tiles.size}getTileCountByLayer(e){let t=0;for(const i of this.tiles.keys())i.endsWith(`,${e}`)&&t++;return t}getChangeHistory(){return this.changeHistory}serialize(){const e=[];for(const t of this.tiles.values())e.push({position:t.position,layer:t.layer,typeId:t.typeId,variant:t.variant});return e}deserialize(e){this.clear();for(const t of e)this.setTile(t.position.x,t.position.y,t.layer,t.typeId,t.variant??0);this.pendingChanges=[]}processPendingChanges(){const e=h();for(const t of this.pendingChanges)e.emit("world:tileChanged",{position:t.position,layer:t.layer,oldTypeId:t.oldTypeId,newTypeId:t.newTypeId}),this.changeHistory.push(t),this.changeHistory.length>this.maxHistorySize&&this.changeHistory.shift();this.pendingChanges=[]}destroy(){this.clear(),console.log("[TilemapManager] Destroyed")}}var J=(n=>(n[n.North=1]="North",n[n.East=2]="East",n[n.South=4]="South",n[n.West=8]="West",n))(J||{}),ee=(n=>(n[n.NorthWest=1]="NorthWest",n[n.North=2]="North",n[n.NorthEast=4]="NorthEast",n[n.West=8]="West",n[n.East=16]="East",n[n.SouthWest=32]="SouthWest",n[n.South=64]="South",n[n.SouthEast=128]="SouthEast",n))(ee||{});const xe={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15},De=new Map([[0,0],[2,1],[16,2],[64,3],[8,4],[66,5],[24,6],[18,7],[22,8],[80,9],[208,10],[72,11],[104,12],[10,13],[11,14],[82,15],[86,16],[210,17],[214,18],[88,19],[216,20],[120,21],[248,22],[74,23],[75,24],[106,25],[107,26],[26,27],[30,28],[27,29],[31,30],[90,31],[94,32],[218,33],[122,34],[91,35],[222,36],[250,37],[123,38],[95,39],[126,40],[219,41],[254,42],[251,43],[127,44],[223,45],[255,46]]);function Ce(n){let e=n;return n&1&&!(n&2&&n&8)&&(e&=-2),n&4&&!(n&2&&n&16)&&(e&=-5),n&32&&!(n&64&&n&8)&&(e&=-33),n&128&&!(n&64&&n&16)&&(e&=-129),e}function qe(n){const e=Ce(n);return De.get(e)??0}class te{name="AutotileSystem";tilemapManager=null;pendingUpdates=new Set;unsubscribe=null;initialize(){const e=h();this.unsubscribe=e.on("world:tileChanged",t=>{this.onTileChanged(t)}),console.log("[AutotileSystem] Initialized")}setTilemapManager(e){this.tilemapManager=e}update(e,t){if(!(this.pendingUpdates.size===0||!this.tilemapManager)){for(const i of this.pendingUpdates){const[s,o,a]=i.split(",").map(Number);this.updateTileVariant(s,o,a)}this.pendingUpdates.clear()}}onTileChanged(e){const{position:t,layer:i}=e;this.queueUpdate(t.x,t.y,i),this.queueUpdate(t.x,t.y-1,i),this.queueUpdate(t.x+1,t.y,i),this.queueUpdate(t.x,t.y+1,i),this.queueUpdate(t.x-1,t.y,i),this.queueUpdate(t.x+1,t.y-1,i),this.queueUpdate(t.x-1,t.y-1,i),this.queueUpdate(t.x+1,t.y+1,i),this.queueUpdate(t.x-1,t.y+1,i)}queueUpdate(e,t,i){this.pendingUpdates.add(`${e},${t},${i}`)}updateTileVariant(e,t,i){if(!this.tilemapManager)return;const s=this.tilemapManager.getTile(e,t,i);if(!s)return;const a=A().get(s.typeId);if(!a||!a.autotileGroup)return;const r=this.calculateVariant(e,t,i,a.autotileGroup);s.variant!==r&&(s.variant=r)}calculateVariant(e,t,i,s){if(!this.tilemapManager)return 0;const o=A(),a=(c,u)=>{const d=this.tilemapManager.getTile(c,u,i);return d?o.get(d.typeId)?.autotileGroup===s:!1};let r=0;return a(e,t-1)&&(r|=1),a(e+1,t)&&(r|=2),a(e,t+1)&&(r|=4),a(e-1,t)&&(r|=8),xe[r]??0}calculateVariant8Bit(e,t,i,s){if(!this.tilemapManager)return 0;const o=A(),a=(c,u)=>{const d=this.tilemapManager.getTile(c,u,i);return d?o.get(d.typeId)?.autotileGroup===s:!1};let r=0;return a(e-1,t-1)&&(r|=1),a(e,t-1)&&(r|=2),a(e+1,t-1)&&(r|=4),a(e-1,t)&&(r|=8),a(e+1,t)&&(r|=16),a(e-1,t+1)&&(r|=32),a(e,t+1)&&(r|=64),a(e+1,t+1)&&(r|=128),qe(r)}updateRegion(e,t,i,s,o){for(let a=e;a<e+i;a++)for(let r=t;r<t+s;r++)this.queueUpdate(a,r,o)}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.pendingUpdates.clear(),console.log("[AutotileSystem] Destroyed")}}const Pe={regionSize:64,loadDistance:2,unloadDistance:3};class ie{name="RegionManager";config;regions=new Map;loadedRegions=new Set;playerPosition={x:0,y:0};lastPlayerRegion={x:0,y:0};constructor(e={}){this.config={...Pe,...e}}initialize(){h().on("player:moved",t=>{this.playerPosition=t.position}),console.log("[RegionManager] Initialized with config:",this.config)}update(e,t){const i=this.worldToRegion(this.playerPosition.x,this.playerPosition.y);(i.x!==this.lastPlayerRegion.x||i.y!==this.lastPlayerRegion.y)&&(this.updateLoadedRegions(i),this.lastPlayerRegion=i)}worldToRegion(e,t){return{x:Math.floor(e/this.config.regionSize),y:Math.floor(t/this.config.regionSize)}}regionToWorld(e,t){return{x:e*this.config.regionSize,y:t*this.config.regionSize}}getRegionId(e,t){return`${e},${t}`}parseRegionId(e){const[t,i]=e.split(",").map(Number);return{x:t,y:i}}isRegionLoaded(e,t){return this.loadedRegions.has(this.getRegionId(e,t))}getRegion(e,t){return this.regions.get(this.getRegionId(e,t))}getOrCreateRegion(e,t){const i=this.getRegionId(e,t);let s=this.regions.get(i);return s||(s={id:i,position:{x:e,y:t},tiles:new Map,isLoaded:!1,lastAccessTime:Date.now()},this.regions.set(i,s)),s}loadRegion(e,t){const i=this.getOrCreateRegion(e,t);return i.isLoaded||(i.isLoaded=!0,i.lastAccessTime=Date.now(),this.loadedRegions.add(i.id),h().emit("world:regionLoaded",{regionId:i.id,position:i.position}),console.log(`[RegionManager] Loaded region ${i.id}`)),i}unloadRegion(e,t){const i=this.getRegionId(e,t),s=this.regions.get(i);s&&s.isLoaded&&(s.isLoaded=!1,this.loadedRegions.delete(i),h().emit("world:regionUnloaded",{regionId:i}),console.log(`[RegionManager] Unloaded region ${i}`))}updateLoadedRegions(e){const{loadDistance:t,unloadDistance:i}=this.config,s=new Set;for(let o=-t;o<=t;o++)for(let a=-t;a<=t;a++){const r=e.x+o,c=e.y+a;s.add(this.getRegionId(r,c))}for(const o of s)if(!this.loadedRegions.has(o)){const{x:a,y:r}=this.parseRegionId(o);this.loadRegion(a,r)}for(const o of this.loadedRegions){const{x:a,y:r}=this.parseRegionId(o),c=Math.abs(a-e.x),u=Math.abs(r-e.y);(c>i||u>i)&&this.unloadRegion(a,r)}}getLoadedRegions(){const e=[];for(const t of this.loadedRegions){const i=this.regions.get(t);i&&e.push(i)}return e}getLoadedRegionCount(){return this.loadedRegions.size}setRegionTile(e,t,i,s){const o=this.worldToRegion(e,t),a=this.getOrCreateRegion(o.x,o.y),r=e-o.x*this.config.regionSize,c=t-o.y*this.config.regionSize,u=`${r},${c},${i}`;a.tiles.set(u,s),a.lastAccessTime=Date.now()}getRegionTile(e,t,i){const s=this.worldToRegion(e,t),o=this.regions.get(this.getRegionId(s.x,s.y));if(!o)return;const a=e-s.x*this.config.regionSize,r=t-s.y*this.config.regionSize,c=`${a},${r},${i}`;return o.lastAccessTime=Date.now(),o.tiles.get(c)}serializeRegion(e,t){const i=this.getRegion(e,t);if(!i)return null;const s=[];for(const[o,a]of i.tiles)s.push({key:o,tile:a});return{id:i.id,position:i.position,tiles:s}}deserializeRegion(e){const t=this.getOrCreateRegion(e.position.x,e.position.y);t.tiles.clear();for(const{key:i,tile:s}of e.tiles)t.tiles.set(i,s)}clear(){this.regions.clear(),this.loadedRegions.clear(),this.lastPlayerRegion={x:0,y:0}}getRegionSize(){return this.config.regionSize}destroy(){this.clear(),console.log("[RegionManager] Destroyed")}}const Ae={seed:12345,octaves:4,scale:.01,persistence:.5,lacunarity:2},Be={seed:54321,octaves:3,scale:.015,persistence:.5,lacunarity:2};function se(n){const e=new Uint8Array(512),t=new Uint8Array(256);for(let s=0;s<256;s++)t[s]=s;let i=n;for(let s=255;s>0;s--){i=i*1103515245+12345&2147483647;const o=i%(s+1);[t[s],t[o]]=[t[o],t[s]]}for(let s=0;s<256;s++)e[s]=t[s],e[s+256]=t[s];return e}const F=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];class ne{perm;seed;constructor(e=Date.now()){this.seed=e,this.perm=se(e)}getSeed(){return this.seed}reseed(e){this.seed=e,this.perm=se(e)}perlin2D(e,t){const i=Math.floor(e)&255,s=Math.floor(t)&255,o=e-Math.floor(e),a=t-Math.floor(t),r=this.fade(o),c=this.fade(a),u=this.perm[this.perm[i]+s],d=this.perm[this.perm[i]+s+1],g=this.perm[this.perm[i+1]+s],m=this.perm[this.perm[i+1]+s+1],y=this.grad2D(u,o,a),S=this.grad2D(g,o-1,a),b=this.grad2D(d,o,a-1),I=this.grad2D(m,o-1,a-1),T=this.lerp(y,S,r),R=this.lerp(b,I,r);return this.lerp(T,R,c)}perlinFBM(e,t,i={}){const{octaves:s,scale:o,persistence:a,lacunarity:r}={...Ae,...i};let c=0,u=1,d=o,g=0;for(let m=0;m<s;m++)c+=this.perlin2D(e*d,t*d)*u,g+=u,u*=a,d*=r;return(c/g+1)/2}simplex2D(e,t){const i=.5*(Math.sqrt(3)-1),s=(3-Math.sqrt(3))/6,o=(e+t)*i,a=Math.floor(e+o),r=Math.floor(t+o),c=(a+r)*s,u=a-c,d=r-c,g=e-u,m=t-d;let y,S;g>m?(y=1,S=0):(y=0,S=1);const b=g-y+s,I=m-S+s,T=g-1+2*s,R=m-1+2*s,P=a&255,K=r&255,Ye=this.perm[P+this.perm[K]]%12,Ze=this.perm[P+y+this.perm[K+S]]%12,Je=this.perm[P+1+this.perm[K+1]]%12;let Ie=0,Me=0,Te=0,z=.5-g*g-m*m;z>=0&&(z*=z,Ie=z*z*this.dot2D(F[Ye],g,m));let W=.5-b*b-I*I;W>=0&&(W*=W,Me=W*W*this.dot2D(F[Ze],b,I));let G=.5-T*T-R*R;return G>=0&&(G*=G,Te=G*G*this.dot2D(F[Je],T,R)),70*(Ie+Me+Te)}simplexFBM(e,t,i={}){const{octaves:s,scale:o,persistence:a,lacunarity:r}={...Be,...i};let c=0,u=1,d=o,g=0;for(let m=0;m<s;m++)c+=this.simplex2D(e*d,t*d)*u,g+=u,u*=a,d*=r;return(c/g+1)/2}voronoi2D(e,t,i=.005){const s=e*i,o=t*i,a=Math.floor(s),r=Math.floor(o);let c=10;for(let u=-1;u<=1;u++)for(let d=-1;d<=1;d++){const g=a+u,m=r+d,y=this.perm[(g&255)+this.perm[m&255]],S=g+y/256,b=m+y*7%256/256,I=s-S,T=o-b,R=Math.sqrt(I*I+T*T);R<c&&(c=R)}return Math.min(c/1.5,1)}voronoiCellId(e,t,i=.005){const s=e*i,o=t*i,a=Math.floor(s),r=Math.floor(o);let c=10,u=0;for(let d=-1;d<=1;d++)for(let g=-1;g<=1;g++){const m=a+d,y=r+g,S=this.perm[(m&255)+this.perm[y&255]],b=m+S/256,I=y+S*7%256/256,T=s-b,R=o-I,P=Math.sqrt(T*T+R*R);P<c&&(c=P,u=m*73856093^y*19349663)}return Math.abs(u)}fade(e){return e*e*e*(e*(e*6-15)+10)}lerp(e,t,i){return e+i*(t-e)}grad2D(e,t,i){const s=e&3,o=s<2?t:i,a=s<2?i:t;return(s&1?-o:o)+(s&2?-a:a)}dot2D(e,t,i){return e[0]*t+e[1]*i}}const D={height:{octaves:4,scale:.01,persistence:.5,lacunarity:2},moisture:{octaves:3,scale:.015,persistence:.5,lacunarity:2},temperature:{octaves:2,scale:.008,persistence:.6,lacunarity:2}};var L=(n=>(n.Ocean="ocean",n.Beach="beach",n.Desert="desert",n.Plains="plains",n.Forest="forest",n.Swamp="swamp",n.Mountains="mountains",n.Snow="snow",n.Tundra="tundra",n.Jungle="jungle",n))(L||{});const oe=new Map([["ocean",{id:"ocean",name:"Ocean",color:"#1a5276",groundTile:"water_deep",decorationTiles:["seaweed","coral"],decorationDensity:.05,resourceTiles:["fish_spot"],resourceDensity:.02,walkable:!1,buildable:!1,hostileSpawnRate:.5}],["beach",{id:"beach",name:"Beach",color:"#f9e79f",groundTile:"sand",decorationTiles:["palm_tree","shell","driftwood"],decorationDensity:.08,resourceTiles:["coconut","crab"],resourceDensity:.03,walkable:!0,buildable:!0,hostileSpawnRate:.2}],["desert",{id:"desert",name:"Desert",color:"#f5b041",groundTile:"sand",decorationTiles:["cactus","dead_bush","skull"],decorationDensity:.04,resourceTiles:["iron_ore","gold_ore"],resourceDensity:.02,walkable:!0,buildable:!0,hostileSpawnRate:.8}],["plains",{id:"plains",name:"Plains",color:"#82e0aa",groundTile:"grass",decorationTiles:["tall_grass","flower_red","flower_yellow","small_rock"],decorationDensity:.15,resourceTiles:["berry_bush","fiber_plant"],resourceDensity:.05,walkable:!0,buildable:!0,hostileSpawnRate:.3}],["forest",{id:"forest",name:"Forest",color:"#1e8449",groundTile:"grass",decorationTiles:["tree_oak","tree_birch","bush","mushroom","fallen_log"],decorationDensity:.35,resourceTiles:["wood_log","berry_bush","mushroom_edible","herb"],resourceDensity:.08,walkable:!0,buildable:!0,hostileSpawnRate:.5}],["swamp",{id:"swamp",name:"Swamp",color:"#6c7a32",groundTile:"mud",decorationTiles:["dead_tree","cattail","lily_pad","moss_rock"],decorationDensity:.25,resourceTiles:["slime_mold","swamp_herb","clay"],resourceDensity:.06,walkable:!0,buildable:!1,hostileSpawnRate:1}],["mountains",{id:"mountains",name:"Mountains",color:"#7f8c8d",groundTile:"stone",decorationTiles:["boulder","pine_tree","mountain_flower"],decorationDensity:.12,resourceTiles:["iron_ore","copper_ore","coal","crystal"],resourceDensity:.1,walkable:!0,buildable:!0,hostileSpawnRate:.6}],["snow",{id:"snow",name:"Snow",color:"#ecf0f1",groundTile:"snow",decorationTiles:["pine_tree_snowy","ice_crystal","snowman"],decorationDensity:.1,resourceTiles:["ice","frozen_herb"],resourceDensity:.03,walkable:!0,buildable:!0,hostileSpawnRate:.4}],["tundra",{id:"tundra",name:"Tundra",color:"#bdc3c7",groundTile:"frozen_grass",decorationTiles:["dead_bush","small_rock","lichen"],decorationDensity:.08,resourceTiles:["fiber_plant","flint"],resourceDensity:.04,walkable:!0,buildable:!0,hostileSpawnRate:.3}],["jungle",{id:"jungle",name:"Jungle",color:"#145a32",groundTile:"jungle_grass",decorationTiles:["jungle_tree","giant_fern","vine","exotic_flower"],decorationDensity:.45,resourceTiles:["tropical_fruit","rare_herb","bamboo"],resourceDensity:.1,walkable:!0,buildable:!1,hostileSpawnRate:1.2}]]),_e={heightOcean:.3,heightBeach:.35,heightMountain:.75,heightSnow:.85,moistureDry:.25,moistureMedium:.5,moistureWet:.75,temperatureCold:.3,temperatureHot:.7};class ae{thresholds;constructor(e={}){this.thresholds={..._e,...e}}determineBiome(e,t,i=.5){const s=this.thresholds;return e<s.heightOcean?"ocean":e<s.heightBeach?"beach":e>s.heightSnow?"snow":e>s.heightMountain?i<s.temperatureCold?"snow":"mountains":i<s.temperatureCold?t<s.moistureMedium?"tundra":"snow":i>s.temperatureHot?t<s.moistureDry?"desert":t>s.moistureWet?"jungle":"plains":t<s.moistureDry?"desert":t<s.moistureMedium?"plains":t<s.moistureWet?"forest":"swamp"}getBiomeDefinition(e){return oe.get(e)}getAllBiomes(){return Array.from(oe.values())}isWalkable(e){return this.getBiomeDefinition(e).walkable}isBuildable(e){return this.getBiomeDefinition(e).buildable}getGroundTile(e){return this.getBiomeDefinition(e).groundTile}getRandomDecoration(e,t){const i=this.getBiomeDefinition(e);if(t>i.decorationDensity||i.decorationTiles.length===0)return null;const s=Math.floor(t*i.decorationTiles.length/i.decorationDensity);return i.decorationTiles[s%i.decorationTiles.length]}getRandomResource(e,t){const i=this.getBiomeDefinition(e);if(t>i.resourceDensity||i.resourceTiles.length===0)return null;const s=Math.floor(t*i.resourceTiles.length/i.resourceDensity);return i.resourceTiles[s%i.resourceTiles.length]}getHostileSpawnRate(e){return this.getBiomeDefinition(e).hostileSpawnRate}}let U=null;function re(){return U||(U=new ae),U}const ze={seed:Date.now(),regionSize:64,seaLevel:.35,temperatureLatitudeScale:.001,spawnAreaSize:32};class ce{config;noise;biomeManager;constructor(e={}){this.config={...ze,...e},this.noise=new ne(this.config.seed),this.biomeManager=re()}getSeed(){return this.config.seed}generateRegion(e,t){const i=performance.now(),s=[],o=new Map,{regionSize:a}=this.config,r=e*a,c=t*a;for(let d=0;d<a;d++)for(let g=0;g<a;g++){const m=r+d,y=c+g,S=this.generateTile(m,y);if(s.push(...S),S.length>0){const b=S[0].biome;o.set(b,(o.get(b)??0)+1)}}const u=performance.now()-i;return{regionX:e,regionY:t,tiles:s,biomeDistribution:o,generationTimeMs:u}}generateTile(e,t){const i=[],s=this.noise.perlinFBM(e,t,D.height),o=this.noise.simplexFBM(e,t,D.moisture),a=this.getTemperature(e,t),r=this.biomeManager.determineBiome(s,o,a),c=this.biomeManager.getBiomeDefinition(r);i.push({x:e,y:t,layer:p.Ground,tileId:c.groundTile,biome:r});const u=this.noise.perlin2D(e*.5+1e3,t*.5)*.5+.5,d=this.biomeManager.getRandomDecoration(r,u);d&&i.push({x:e,y:t,layer:p.Objects,tileId:d,biome:r});const g=this.noise.simplex2D(e*.3+2e3,t*.3)*.5+.5,m=this.biomeManager.getRandomResource(r,g);return m&&!d&&i.push({x:e,y:t,layer:p.Objects,tileId:m,biome:r}),i}getTemperature(e,t){const{temperatureLatitudeScale:i}=this.config,s=this.noise.simplexFBM(e+5e3,t+5e3,D.temperature),o=1-Math.abs(t*i),a=this.noise.perlinFBM(e,t,D.height),r=1-Math.max(0,(a-.5)*.5);return Math.max(0,Math.min(1,s*.5+o*.3+r*.2))}findSpawnPoint(){const{spawnAreaSize:e}=this.config;for(let t=0;t<100;t+=5)for(let i=0;i<Math.PI*2;i+=Math.PI/8){const s=Math.round(Math.cos(i)*t),o=Math.round(Math.sin(i)*t);if(this.isSuitableSpawn(s,o))return{x:s,y:o}}return{x:0,y:0}}isSuitableSpawn(e,t){const i=this.generateTile(e,t);if(i.length===0)return!1;const s=i[0].biome;return!this.biomeManager.isWalkable(s)||!this.biomeManager.isBuildable(s)||this.biomeManager.getHostileSpawnRate(s)>.5?!1:s===L.Plains||s===L.Forest}getBiomeAt(e,t){const i=this.noise.perlinFBM(e,t,D.height),s=this.noise.simplexFBM(e,t,D.moisture),o=this.getTemperature(e,t);return this.biomeManager.determineBiome(i,s,o)}getHeightAt(e,t){return this.noise.perlinFBM(e,t,D.height)}isLand(e,t){return this.getHeightAt(e,t)>=this.config.seaLevel}validateGeneration(e=1e3){const t=new Map;let i=0;const s=Math.sqrt(e);for(let r=0;r<s;r++)for(let c=0;c<s;c++){const u=(r-s/2)*10,d=(c-s/2)*10,g=performance.now(),m=this.getBiomeAt(u,d);i+=performance.now()-g,t.set(m,(t.get(m)??0)+1)}const o=t.size;return{valid:o>=5,biomeCount:o,biomeCounts:t,averageGenerationTime:i/e}}}let H=null;function We(n){return(!H||n!==void 0)&&(H=new ce(n!==void 0?{seed:n}:{})),H}function Ge(){H=null}var ue=(n=>(n.Idle="idle",n.Walking="walking",n.Running="running",n.Interacting="interacting",n.InMenu="inMenu",n.Combat="combat",n))(ue||{});const Oe={walkSpeed:4,runSpeed:7,acceleration:20,deceleration:15};class le{name="PlayerController";config;position={x:0,y:0};velocity={x:0,y:0};facing=w.South;state="idle";moveInput={x:0,y:0};digitalMoveInput={x:0,y:0};analogMoveInput={x:0,y:0};isSprinting=!1;checkWalkable=null;constructor(e={}){this.config={...Oe,...e}}initialize(){const e=h();e.on("input:actionPressed",this.onActionPressed.bind(this)),e.on("input:actionReleased",this.onActionReleased.bind(this)),e.on("input:leftStickMoved",this.onLeftStickMoved.bind(this)),console.log("[PlayerController] Initialized")}setWalkableCheck(e){this.checkWalkable=e}onActionPressed(e){switch(e.action){case"moveUp":this.digitalMoveInput.y=-1;break;case"moveDown":this.digitalMoveInput.y=1;break;case"moveLeft":this.digitalMoveInput.x=-1;break;case"moveRight":this.digitalMoveInput.x=1;break;case"sprint":this.isSprinting=!0;break;case"interact":this.interact();break}this.updateCombinedInput()}onActionReleased(e){switch(e.action){case"moveUp":this.digitalMoveInput.y<0&&(this.digitalMoveInput.y=0);break;case"moveDown":this.digitalMoveInput.y>0&&(this.digitalMoveInput.y=0);break;case"moveLeft":this.digitalMoveInput.x<0&&(this.digitalMoveInput.x=0);break;case"moveRight":this.digitalMoveInput.x>0&&(this.digitalMoveInput.x=0);break;case"sprint":this.isSprinting=!1;break}this.updateCombinedInput()}onLeftStickMoved(e){this.analogMoveInput={x:e.x,y:e.y},this.updateCombinedInput()}updateCombinedInput(){Math.sqrt(this.analogMoveInput.x**2+this.analogMoveInput.y**2)>.1?this.moveInput={...this.analogMoveInput}:this.moveInput={...this.digitalMoveInput}}fixedUpdate(e,t){this.state==="inMenu"||this.state==="interacting"||this.updateMovement(e)}updateMovement(e){const{acceleration:t,deceleration:i,walkSpeed:s,runSpeed:o}=this.config;let a=this.moveInput.x,r=this.moveInput.y;const c=Math.sqrt(a*a+r*r);c>1&&(a/=c,r/=c);const u=this.isSprinting?o:s,d=a*u,g=r*u;c>0?(this.velocity.x=this.approach(this.velocity.x,d,t*e),this.velocity.y=this.approach(this.velocity.y,g,t*e)):(this.velocity.x=this.approach(this.velocity.x,0,i*e),this.velocity.y=this.approach(this.velocity.y,0,i*e));const m=this.position.x+this.velocity.x*e,y=this.position.y+this.velocity.y*e,S=this.canMoveTo(m,this.position.y),b=this.canMoveTo(this.position.x,y),I={...this.position};S?this.position.x=m:this.velocity.x=0,b?this.position.y=y:this.velocity.y=0,c>0&&(this.facing=this.calculateFacing(a,r)),this.updateState(),(this.position.x!==I.x||this.position.y!==I.y)&&h().emit("player:moved",{position:{...this.position}})}canMoveTo(e,t){if(!this.checkWalkable)return!0;const i=Math.floor(e),s=Math.floor(t);return this.checkWalkable(i,s)}calculateFacing(e,t){return Math.abs(t)>=Math.abs(e)?t<0?w.North:w.South:e<0?w.West:w.East}updateState(){const e=Math.sqrt(this.velocity.x**2+this.velocity.y**2);e<.1?this.state="idle":this.isSprinting&&e>this.config.walkSpeed*.9?this.state="running":this.state="walking"}interact(){const e=Math.floor(this.position.x+this.getFacingOffset().x),t=Math.floor(this.position.y+this.getFacingOffset().y);h().emit("player:interacted",{targetId:null,position:{x:e,y:t}})}getFacingOffset(){switch(this.facing){case w.North:return{x:0,y:-1};case w.South:return{x:0,y:1};case w.East:return{x:1,y:0};case w.West:return{x:-1,y:0};default:return{x:0,y:0}}}approach(e,t,i){return e<t?Math.min(e+i,t):Math.max(e-i,t)}getPosition(){return this.position}setPosition(e,t){this.position={x:e,y:t},this.velocity={x:0,y:0},h().emit("player:moved",{position:{...this.position}})}getVelocity(){return this.velocity}getFacing(){return this.facing}getState(){return this.state}setState(e){this.state=e,(e==="inMenu"||e==="interacting")&&(this.velocity={x:0,y:0})}isMoving(){return this.state==="walking"||this.state==="running"}destroy(){console.log("[PlayerController] Destroyed")}}const Le={followSpeed:5,deadzone:.5,minZoom:.5,maxZoom:2,zoomSpeed:2,shakeDecay:5,viewportWidth:20,viewportHeight:15};class de{name="CameraSystem";config;position={x:0,y:0};targetPosition={x:0,y:0};zoom=1;targetZoom=1;shakeIntensity=0;shakeOffset={x:0,y:0};bounds=null;constructor(e={}){this.config={...Le,...e}}initialize(){const e=h();e.on("player:moved",t=>{this.setTarget(t.position.x,t.position.y)}),e.on("input:actionPressed",t=>{t.action==="zoomIn"?this.zoomIn():t.action==="zoomOut"&&this.zoomOut()}),console.log("[CameraSystem] Initialized")}lateUpdate(e,t){this.updateFollow(e),this.updateZoom(e),this.updateShake(e)}updateFollow(e){const{followSpeed:t,deadzone:i}=this.config,s=this.targetPosition.x-this.position.x,o=this.targetPosition.y-this.position.y,a=Math.sqrt(s*s+o*o);if(a>i){const r=t*e;if(r>=a)this.position.x=this.targetPosition.x,this.position.y=this.targetPosition.y;else{const c=r/a;this.position.x+=s*c,this.position.y+=o*c}}this.bounds&&this.clampToBounds()}updateZoom(e){if(this.zoom!==this.targetZoom){const{zoomSpeed:t}=this.config,i=this.targetZoom-this.zoom,s=t*e;Math.abs(i)<=s?this.zoom=this.targetZoom:this.zoom+=Math.sign(i)*s}}updateShake(e){if(this.shakeIntensity>0){const t=Math.random()*Math.PI*2;this.shakeOffset.x=Math.cos(t)*this.shakeIntensity,this.shakeOffset.y=Math.sin(t)*this.shakeIntensity,this.shakeIntensity-=this.config.shakeDecay*e,this.shakeIntensity<0&&(this.shakeIntensity=0,this.shakeOffset.x=0,this.shakeOffset.y=0)}}clampToBounds(){if(!this.bounds)return;const e=this.getViewWidth()/2,t=this.getViewHeight()/2;this.position.x=Math.max(this.bounds.x+e,Math.min(this.bounds.x+this.bounds.width-e,this.position.x)),this.position.y=Math.max(this.bounds.y+t,Math.min(this.bounds.y+this.bounds.height-t,this.position.y))}setTarget(e,t){this.targetPosition.x=e,this.targetPosition.y=t}snapTo(e,t){this.position.x=e,this.position.y=t,this.targetPosition.x=e,this.targetPosition.y=t}getPosition(){return{x:this.position.x+this.shakeOffset.x,y:this.position.y+this.shakeOffset.y}}getRawPosition(){return this.position}getZoom(){return this.zoom}setZoom(e){this.targetZoom=Math.max(this.config.minZoom,Math.min(this.config.maxZoom,e))}zoomIn(){this.setZoom(this.targetZoom*1.2)}zoomOut(){this.setZoom(this.targetZoom/1.2)}shake(e){this.shakeIntensity=Math.max(this.shakeIntensity,e)}setBounds(e){this.bounds=e,e&&this.clampToBounds()}getViewBounds(){const e=this.getViewWidth()/2,t=this.getViewHeight()/2,i=this.getPosition();return{x:i.x-e,y:i.y-t,width:this.getViewWidth(),height:this.getViewHeight()}}getViewWidth(){return this.config.viewportWidth/this.zoom}getViewHeight(){return this.config.viewportHeight/this.zoom}screenToWorld(e,t,i,s){const o=this.getPosition(),a=this.getViewWidth(),r=this.getViewHeight();return{x:o.x+(e/i-.5)*a,y:o.y+(t/s-.5)*r}}worldToScreen(e,t,i,s){const o=this.getPosition(),a=this.getViewWidth(),r=this.getViewHeight();return{x:((e-o.x)/a+.5)*i,y:((t-o.y)/r+.5)*s}}isVisible(e,t,i=0){const s=this.getViewBounds();return e>=s.x-i&&e<=s.x+s.width+i&&t>=s.y-i&&t<=s.y+s.height+i}destroy(){console.log("[CameraSystem] Destroyed")}}const He="0.1.0",q="voxel_rpg_save_",Ee=10;class he{name="SaveManager";stateProvider=null;stateConsumer=null;autosaveInterval=null;autosaveSlot="autosave";initialize(){console.log("[SaveManager] Initialized")}setStateProvider(e){this.stateProvider=e}setStateConsumer(e){this.stateConsumer=e}getSaveSlots(){const e=[];for(let o=1;o<=Ee;o++){const a=`slot${o}`,r=q+a,c=localStorage.getItem(r)!==null,u={slot:a,exists:c};if(c)try{const d=JSON.parse(localStorage.getItem(r));u.metadata=d.metadata}catch{}e.push(u)}const t=q+this.autosaveSlot,i=localStorage.getItem(t)!==null,s={slot:this.autosaveSlot,exists:i};if(i)try{const o=JSON.parse(localStorage.getItem(t));s.metadata=o.metadata}catch{}return e.unshift(s),e}async saveGame(e){if(!this.stateProvider)return console.error("[SaveManager] No state provider set"),!1;const t=h();t.emit("save:started",{slot:e});try{const i=this.createSaveData(e),s=JSON.stringify(i),o=q+e;return localStorage.setItem(o,s),t.emit("save:completed",{slot:e}),console.log(`[SaveManager] Game saved to slot "${e}"`),!0}catch(i){const s=i instanceof Error?i.message:"Unknown error";return t.emit("save:failed",{slot:e,error:s}),console.error("[SaveManager] Save failed:",i),!1}}async loadGame(e){if(!this.stateConsumer)return console.error("[SaveManager] No state consumer set"),!1;const t=h();t.emit("load:started",{slot:e});try{const i=q+e,s=localStorage.getItem(i);if(!s)throw new Error(`Save slot "${e}" not found`);const o=JSON.parse(s),a=this.migrateData(o);return this.applySaveData(a),t.emit("load:completed",{slot:e}),console.log(`[SaveManager] Game loaded from slot "${e}"`),!0}catch(i){const s=i instanceof Error?i.message:"Unknown error";return t.emit("load:failed",{slot:e,error:s}),console.error("[SaveManager] Load failed:",i),!1}}deleteSave(e){try{const t=q+e;return localStorage.removeItem(t),console.log(`[SaveManager] Deleted save slot "${e}"`),!0}catch(t){return console.error("[SaveManager] Delete failed:",t),!1}}saveExists(e){const t=q+e;return localStorage.getItem(t)!==null}enableAutosave(e){this.disableAutosave(),this.autosaveInterval=window.setInterval(()=>{this.saveGame(this.autosaveSlot)},e*1e3),console.log(`[SaveManager] Autosave enabled every ${e} seconds`)}disableAutosave(){this.autosaveInterval!==null&&(window.clearInterval(this.autosaveInterval),this.autosaveInterval=null,console.log("[SaveManager] Autosave disabled"))}createSaveData(e){const t=this.stateProvider;return{metadata:{version:He,timestamp:Date.now(),playtimeSeconds:t.getTotalPlaytime(),slotName:e},world:{seed:t.getWorldSeed(),modifiedTiles:t.getModifiedTiles()},player:{position:t.getPlayerPosition(),health:t.getPlayerHealth(),maxHealth:t.getPlayerMaxHealth(),inventory:t.getPlayerInventory()},gameTime:{totalSeconds:t.getTotalPlaytime(),gameDay:t.getGameDay()}}}applySaveData(e){const t=this.stateConsumer;t.loadWorldSeed(e.world.seed),t.loadModifiedTiles(e.world.modifiedTiles),t.loadPlayerPosition(e.player.position),t.loadPlayerHealth(e.player.health,e.player.maxHealth),t.loadPlayerInventory(e.player.inventory),t.loadPlaytime(e.gameTime.totalSeconds),t.loadGameDay(e.gameTime.gameDay)}migrateData(e){return e}destroy(){this.disableAutosave(),console.log("[SaveManager] Destroyed")}}const Fe=[{action:"moveUp",keys:["KeyW","ArrowUp"],gamepadButtons:[v.DPadUp]},{action:"moveDown",keys:["KeyS","ArrowDown"],gamepadButtons:[v.DPadDown]},{action:"moveLeft",keys:["KeyA","ArrowLeft"],gamepadButtons:[v.DPadLeft]},{action:"moveRight",keys:["KeyD","ArrowRight"],gamepadButtons:[v.DPadRight]},{action:"sprint",keys:["ShiftLeft","ShiftRight"],gamepadButtons:[v.LeftTrigger]},{action:"interact",keys:["KeyE"],gamepadButtons:[v.A]},{action:"attack",keys:[],mouseButtons:[0],gamepadButtons:[v.RightTrigger]},{action:"secondary",keys:[],mouseButtons:[2],gamepadButtons:[v.RightBumper]},{action:"cancel",keys:["Escape"],gamepadButtons:[v.B]},{action:"inventory",keys:["KeyI"],gamepadButtons:[v.Start]},{action:"buildMenu",keys:["KeyB"],gamepadButtons:[v.Select]},{action:"pause",keys:["KeyP","Escape"],gamepadButtons:[v.Start]},{action:"zoomIn",keys:["Equal","NumpadAdd"],gamepadButtons:[v.Y]},{action:"zoomOut",keys:["Minus","NumpadSubtract"],gamepadButtons:[v.X]},{action:"quickSlot1",keys:["Digit1","Numpad1"]},{action:"quickSlot2",keys:["Digit2","Numpad2"]},{action:"quickSlot3",keys:["Digit3","Numpad3"]},{action:"quickSlot4",keys:["Digit4","Numpad4"]},{action:"quickSlot5",keys:["Digit5","Numpad5"]},{action:"quickSlot6",keys:["Digit6","Numpad6"]},{action:"quickSlot7",keys:["Digit7","Numpad7"]},{action:"quickSlot8",keys:["Digit8","Numpad8"]},{action:"quickSlot9",keys:["Digit9","Numpad9"]}],ge={deadzone:.15,triggerThreshold:.5};class me{name="InputManager";bindings=[];keyToAction=new Map;mouseButtonToAction=new Map;gamepadButtonToAction=new Map;pressedKeys=new Set;pressedMouseButtons=new Set;pressedGamepadButtons=new Set;activeActions=new Set;mousePosition={x:0,y:0};mouseWorldPosition={x:0,y:0};activeGamepadIndex=null;leftStickInput={x:0,y:0};rightStickInput={x:0,y:0};gamepadConnected=!1;screenToWorld=null;initialize(){this.setBindings(Fe),window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),window.addEventListener("mousedown",this.onMouseDown.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("contextmenu",this.onContextMenu.bind(this)),window.addEventListener("blur",this.onBlur.bind(this)),window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this)),this.detectGamepads(),console.log("[InputManager] Initialized")}update(e,t){this.pollGamepad()}setBindings(e){this.bindings=[...e],this.rebuildBindingMaps()}getBindings(){return this.bindings}rebindKey(e,t,i){const s=this.bindings.find(o=>o.action===e);if(s){const o=s.keys.indexOf(t);o!==-1&&(s.keys[o]=i,this.rebuildBindingMaps())}}setScreenToWorldConverter(e){this.screenToWorld=e}rebuildBindingMaps(){this.keyToAction.clear(),this.mouseButtonToAction.clear(),this.gamepadButtonToAction.clear();for(const e of this.bindings){for(const t of e.keys){const i=this.keyToAction.get(t)??[];i.push(e.action),this.keyToAction.set(t,i)}if(e.mouseButtons)for(const t of e.mouseButtons){const i=this.mouseButtonToAction.get(t)??[];i.push(e.action),this.mouseButtonToAction.set(t,i)}if(e.gamepadButtons)for(const t of e.gamepadButtons){const i=this.gamepadButtonToAction.get(t)??[];i.push(e.action),this.gamepadButtonToAction.set(t,i)}}}onKeyDown(e){if(this.isTypingInInput(e))return;const t=e.code;if(this.pressedKeys.has(t))return;this.pressedKeys.add(t);const i=this.keyToAction.get(t);if(i){const s=h();for(const o of i)this.activeActions.has(o)||(this.activeActions.add(o),s.emit("input:actionPressed",{action:o}))}}onKeyUp(e){const t=e.code;this.pressedKeys.delete(t);const i=this.keyToAction.get(t);if(i){const s=h();for(const o of i)this.isActionStillPressed(o)||(this.activeActions.delete(o),s.emit("input:actionReleased",{action:o}))}}onMouseDown(e){const t=e.button;this.pressedMouseButtons.add(t);const i=h();i.emit("input:mouseClicked",{button:t,position:{...this.mousePosition},worldPosition:{...this.mouseWorldPosition}});const s=this.mouseButtonToAction.get(t);if(s)for(const o of s)this.activeActions.has(o)||(this.activeActions.add(o),i.emit("input:actionPressed",{action:o}))}onMouseUp(e){const t=e.button;this.pressedMouseButtons.delete(t);const i=this.mouseButtonToAction.get(t);if(i){const s=h();for(const o of i)this.isActionStillPressed(o)||(this.activeActions.delete(o),s.emit("input:actionReleased",{action:o}))}}onMouseMove(e){this.mousePosition={x:e.clientX,y:e.clientY},this.screenToWorld&&(this.mouseWorldPosition=this.screenToWorld(e.clientX,e.clientY)),h().emit("input:mouseMoved",{position:{...this.mousePosition},worldPosition:{...this.mouseWorldPosition}})}onContextMenu(e){e.preventDefault()}onBlur(){const e=h();for(const t of this.activeActions)e.emit("input:actionReleased",{action:t});this.pressedKeys.clear(),this.pressedMouseButtons.clear(),this.pressedGamepadButtons.clear(),this.activeActions.clear(),this.leftStickInput={x:0,y:0},this.rightStickInput={x:0,y:0}}onGamepadConnected(e){console.log(`[InputManager] Gamepad connected: ${e.gamepad.id}`),this.activeGamepadIndex=e.gamepad.index,this.gamepadConnected=!0,h().emit("input:gamepadConnected",{index:e.gamepad.index,id:e.gamepad.id})}onGamepadDisconnected(e){console.log(`[InputManager] Gamepad disconnected: ${e.gamepad.id}`),this.activeGamepadIndex===e.gamepad.index&&(this.activeGamepadIndex=null,this.gamepadConnected=!1,this.pressedGamepadButtons.clear(),this.leftStickInput={x:0,y:0},this.rightStickInput={x:0,y:0},this.detectGamepads()),h().emit("input:gamepadDisconnected",{index:e.gamepad.index,id:e.gamepad.id})}detectGamepads(){const e=navigator.getGamepads();for(const t of e)if(t){this.activeGamepadIndex=t.index,this.gamepadConnected=!0,console.log(`[InputManager] Found gamepad: ${t.id}`);break}}pollGamepad(){if(this.activeGamepadIndex===null)return;const t=navigator.getGamepads()[this.activeGamepadIndex];if(!t){this.activeGamepadIndex=null,this.gamepadConnected=!1;return}this.pollGamepadButtons(t),this.pollGamepadSticks(t)}pollGamepadButtons(e){const t=h();for(let i=0;i<e.buttons.length;i++){const s=e.buttons[i],o=s.pressed||s.value>ge.triggerThreshold,a=this.pressedGamepadButtons.has(i);if(o&&!a){this.pressedGamepadButtons.add(i);const r=this.gamepadButtonToAction.get(i);if(r)for(const c of r)this.activeActions.has(c)||(this.activeActions.add(c),t.emit("input:actionPressed",{action:c}))}else if(!o&&a){this.pressedGamepadButtons.delete(i);const r=this.gamepadButtonToAction.get(i);if(r)for(const c of r)this.isActionStillPressed(c)||(this.activeActions.delete(c),t.emit("input:actionReleased",{action:c}))}}}pollGamepadSticks(e){const{deadzone:t}=ge;let i=e.axes[C.LeftStickX]??0,s=e.axes[C.LeftStickY]??0;Math.abs(i)<t&&(i=0),Math.abs(s)<t&&(s=0);const o=this.leftStickInput.x,a=this.leftStickInput.y;this.leftStickInput={x:i,y:s},(Math.abs(i-o)>.01||Math.abs(s-a)>.01)&&h().emit("input:leftStickMoved",{x:i,y:s});let r=e.axes[C.RightStickX]??0,c=e.axes[C.RightStickY]??0;Math.abs(r)<t&&(r=0),Math.abs(c)<t&&(c=0);const u=this.rightStickInput.x,d=this.rightStickInput.y;this.rightStickInput={x:r,y:c},(Math.abs(r-u)>.01||Math.abs(c-d)>.01)&&h().emit("input:rightStickMoved",{x:r,y:c})}isActionStillPressed(e){const t=this.bindings.find(i=>i.action===e);if(!t)return!1;for(const i of t.keys)if(this.pressedKeys.has(i))return!0;if(t.mouseButtons){for(const i of t.mouseButtons)if(this.pressedMouseButtons.has(i))return!0}if(t.gamepadButtons){for(const i of t.gamepadButtons)if(this.pressedGamepadButtons.has(i))return!0}return!1}isTypingInInput(e){const t=e.target;return t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable}isActionActive(e){return this.activeActions.has(e)}isKeyPressed(e){return this.pressedKeys.has(e)}isMouseButtonPressed(e){return this.pressedMouseButtons.has(e)}getMousePosition(){return this.mousePosition}getMouseWorldPosition(){return this.mouseWorldPosition}getActiveActions(){return this.activeActions}isGamepadConnected(){return this.gamepadConnected}getLeftStick(){return this.leftStickInput}getRightStick(){return this.rightStickInput}isGamepadButtonPressed(e){return this.pressedGamepadButtons.has(e)}getActiveGamepad(){return this.activeGamepadIndex===null?null:navigator.getGamepads()[this.activeGamepadIndex]??null}destroy(){window.removeEventListener("keydown",this.onKeyDown.bind(this)),window.removeEventListener("keyup",this.onKeyUp.bind(this)),window.removeEventListener("mousedown",this.onMouseDown.bind(this)),window.removeEventListener("mouseup",this.onMouseUp.bind(this)),window.removeEventListener("mousemove",this.onMouseMove.bind(this)),window.removeEventListener("contextmenu",this.onContextMenu.bind(this)),window.removeEventListener("blur",this.onBlur.bind(this)),window.removeEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.removeEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this)),this.pressedKeys.clear(),this.pressedMouseButtons.clear(),this.pressedGamepadButtons.clear(),this.activeActions.clear(),console.log("[InputManager] Destroyed")}}var pe=(n=>(n.RawMaterial="raw_material",n.Ore="ore",n.Food="food",n.Tool="tool",n.Weapon="weapon",n.Armor="armor",n.Building="building",n.Special="special",n.Consumable="consumable",n))(pe||{});const Ue=[{id:"wood",name:"Wood",description:"Basic building material gathered from trees",category:"raw_material",stackSize:99,value:2,weight:1},{id:"stone",name:"Stone",description:"Common stone for building and tools",category:"raw_material",stackSize:99,value:1,weight:2},{id:"fiber",name:"Plant Fiber",description:"Flexible plant material for crafting",category:"raw_material",stackSize:99,value:1,weight:.2},{id:"clay",name:"Clay",description:"Moldable earth for pottery and bricks",category:"raw_material",stackSize:50,value:2,weight:1.5},{id:"leather",name:"Leather",description:"Tanned animal hide",category:"raw_material",stackSize:50,value:5,weight:.5},{id:"cloth",name:"Cloth",description:"Woven fabric from plant fibers",category:"raw_material",stackSize:50,value:4,weight:.3},{id:"iron_ore",name:"Iron Ore",description:"Raw iron ore, needs smelting",category:"ore",stackSize:50,value:5,weight:3},{id:"copper_ore",name:"Copper Ore",description:"Raw copper ore, needs smelting",category:"ore",stackSize:50,value:3,weight:2.5},{id:"gold_ore",name:"Gold Ore",description:"Precious gold ore, needs smelting",category:"ore",stackSize:30,value:20,weight:4},{id:"coal",name:"Coal",description:"Fuel for smelting and crafting",category:"ore",stackSize:50,value:2,weight:1},{id:"iron_ingot",name:"Iron Ingot",description:"Smelted iron, ready for crafting",category:"raw_material",stackSize:50,value:10,weight:2},{id:"copper_ingot",name:"Copper Ingot",description:"Smelted copper, ready for crafting",category:"raw_material",stackSize:50,value:6,weight:1.5},{id:"gold_ingot",name:"Gold Ingot",description:"Smelted gold, valuable and beautiful",category:"raw_material",stackSize:30,value:40,weight:3},{id:"berries",name:"Berries",description:"Wild berries, slightly restores hunger",category:"food",stackSize:20,value:1,weight:.1,hungerRestore:5,healAmount:0},{id:"mushroom",name:"Mushroom",description:"Edible forest mushroom",category:"food",stackSize:20,value:2,weight:.1,hungerRestore:8,healAmount:0},{id:"raw_meat",name:"Raw Meat",description:"Uncooked meat, should be cooked before eating",category:"food",stackSize:10,value:5,weight:.5,hungerRestore:10,healAmount:-5},{id:"cooked_meat",name:"Cooked Meat",description:"Well-cooked meat, restores hunger and health",category:"food",stackSize:10,value:10,weight:.4,hungerRestore:25,healAmount:10},{id:"bread",name:"Bread",description:"Baked bread, a staple food",category:"food",stackSize:20,value:8,weight:.2,hungerRestore:20,healAmount:0},{id:"apple",name:"Apple",description:"Fresh apple from a tree",category:"food",stackSize:20,value:3,weight:.2,hungerRestore:10,healAmount:2},{id:"fish",name:"Cooked Fish",description:"Freshly caught and cooked fish",category:"food",stackSize:10,value:12,weight:.4,hungerRestore:30,healAmount:5},{id:"stone_pickaxe",name:"Stone Pickaxe",description:"Basic mining tool",category:"tool",stackSize:1,value:15,weight:3,durability:100,damage:5},{id:"iron_pickaxe",name:"Iron Pickaxe",description:"Sturdy mining tool",category:"tool",stackSize:1,value:50,weight:4,durability:250,damage:8},{id:"stone_axe",name:"Stone Axe",description:"Basic woodcutting tool",category:"tool",stackSize:1,value:15,weight:2.5,durability:100,damage:8},{id:"iron_axe",name:"Iron Axe",description:"Sturdy woodcutting tool",category:"tool",stackSize:1,value:50,weight:3.5,durability:250,damage:12},{id:"wooden_sword",name:"Wooden Sword",description:"A basic wooden sword",category:"weapon",stackSize:1,value:10,weight:1.5,durability:50,damage:10},{id:"stone_sword",name:"Stone Sword",description:"A crude stone blade",category:"weapon",stackSize:1,value:20,weight:3,durability:100,damage:15},{id:"iron_sword",name:"Iron Sword",description:"A sturdy iron blade",category:"weapon",stackSize:1,value:75,weight:2.5,durability:300,damage:25},{id:"bow",name:"Wooden Bow",description:"A ranged weapon for hunting",category:"weapon",stackSize:1,value:30,weight:1,durability:150,damage:20},{id:"arrow",name:"Arrow",description:"Ammunition for bows",category:"weapon",stackSize:50,value:1,weight:.1,damage:5},{id:"health_potion",name:"Health Potion",description:"Restores health when consumed",category:"consumable",stackSize:10,value:25,weight:.5,healAmount:50},{id:"bandage",name:"Bandage",description:"Stops bleeding and heals minor wounds",category:"consumable",stackSize:20,value:5,weight:.1,healAmount:15},{id:"wooden_plank",name:"Wooden Plank",description:"Processed wood for building",category:"building",stackSize:50,value:5,weight:1},{id:"stone_brick",name:"Stone Brick",description:"Cut stone for sturdy construction",category:"building",stackSize:50,value:4,weight:2},{id:"rope",name:"Rope",description:"Woven rope for building and crafting",category:"building",stackSize:30,value:6,weight:.5},{id:"portal_shard",name:"Portal Shard",description:"A mysterious crystal from a closed portal",category:"special",stackSize:10,value:100,weight:.3},{id:"monster_essence",name:"Monster Essence",description:"Magical essence dropped by monsters",category:"special",stackSize:50,value:15,weight:.1}];class fe{resources=new Map;constructor(){for(const e of Ue)this.registerResource(e)}registerResource(e){this.resources.set(e.id,e)}getResource(e){return this.resources.get(e)}getAllResources(){return Array.from(this.resources.values())}getResourcesByCategory(e){return this.getAllResources().filter(t=>t.category===e)}hasResource(e){return this.resources.has(e)}getResourceCount(){return this.resources.size}isStackable(e){const t=this.getResource(e);return t?t.stackSize>1:!1}getStackSize(e){return this.getResource(e)?.stackSize??1}isConsumable(e){const t=this.getResource(e);return t?t.category==="food"||t.category==="consumable":!1}isWeapon(e){return this.getResource(e)?.category==="weapon"}isTool(e){return this.getResource(e)?.category==="tool"}}let N=null;function _(){return N||(N=new fe),N}const Ne={size:30,quickSlots:9};class ye{slots=[];config;selectedQuickSlot=0;constructor(e={}){this.config={...Ne,...e},this.initializeSlots()}initializeSlots(){this.slots=[];for(let e=0;e<this.config.size;e++)this.slots.push({resourceId:null,quantity:0})}getSlots(){return this.slots}getSlot(e){return this.slots[e]}getQuickSlots(){return this.slots.slice(0,this.config.quickSlots)}getSelectedQuickSlot(){return this.selectedQuickSlot}setSelectedQuickSlot(e){e>=0&&e<this.config.quickSlots&&(this.selectedQuickSlot=e)}getItemInHand(){return this.slots[this.selectedQuickSlot]}addItem(e,t=1,i){const o=_().getResource(e);if(!o)return console.warn(`[InventoryManager] Unknown resource: ${e}`),t;let a=t;const r=o.stackSize;if(r>1)for(const c of this.slots){if(a<=0)break;if(c.resourceId===e&&c.quantity<r){const u=Math.min(a,r-c.quantity);c.quantity+=u,a-=u}}for(const c of this.slots){if(a<=0)break;if(c.resourceId===null){const u=Math.min(a,r);c.resourceId=e,c.quantity=u,c.durability=i??o.durability,a-=u}}return a<t&&h().emit("player:inventoryChanged",{itemId:e,delta:t-a}),a}removeItem(e,t=1){let i=t;for(let o=this.slots.length-1;o>=0&&!(i<=0);o--){const a=this.slots[o];if(a.resourceId===e){const r=Math.min(i,a.quantity);a.quantity-=r,i-=r,a.quantity<=0&&(a.resourceId=null,a.quantity=0,a.durability=void 0)}}const s=t-i;return s>0&&h().emit("player:inventoryChanged",{itemId:e,delta:-s}),s}hasItem(e,t=1){return this.getItemCount(e)>=t}getItemCount(e){return this.slots.filter(t=>t.resourceId===e).reduce((t,i)=>t+i.quantity,0)}hasSpace(e,t=1){const s=_().getResource(e);if(!s)return!1;const o=s.stackSize;let a=0;if(o>1)for(const r of this.slots)r.resourceId===e&&(a+=o-r.quantity);for(const r of this.slots)r.resourceId===null&&(a+=o);return a>=t}getEmptySlotCount(){return this.slots.filter(e=>e.resourceId===null).length}isFull(){return this.getEmptySlotCount()===0}moveItem(e,t){if(e<0||e>=this.slots.length||t<0||t>=this.slots.length||e===t)return!1;const i=this.slots[e],s=this.slots[t];if(s.resourceId===null)return s.resourceId=i.resourceId,s.quantity=i.quantity,s.durability=i.durability,i.resourceId=null,i.quantity=0,i.durability=void 0,!0;if(s.resourceId===i.resourceId){const r=_().getResource(s.resourceId);if(r&&r.stackSize>1){const c=Math.min(i.quantity,r.stackSize-s.quantity);return s.quantity+=c,i.quantity-=c,i.quantity<=0&&(i.resourceId=null,i.quantity=0,i.durability=void 0),!0}}const o={...i};return i.resourceId=s.resourceId,i.quantity=s.quantity,i.durability=s.durability,s.resourceId=o.resourceId,s.quantity=o.quantity,s.durability=o.durability,!0}useDurability(e,t=1){const i=this.slots[e];if(!i||i.durability===void 0)return!1;if(i.durability-=t,i.durability<=0){const s=i.resourceId;return i.resourceId=null,i.quantity=0,i.durability=void 0,h().emit("player:inventoryChanged",{itemId:s,delta:-1}),!0}return!1}clear(){this.initializeSlots()}serialize(){const e=[];for(const t of this.slots)t.resourceId&&e.push({itemId:t.resourceId,quantity:t.quantity,durability:t.durability});return e}deserialize(e){this.clear();for(const t of e)this.addItem(t.itemId,t.quantity,t.durability)}}let $=null;function $e(){return $||($=new ye),$}var Se=(n=>(n.Hand="hand",n.Workbench="workbench",n.Furnace="furnace",n.Anvil="anvil",n.Alchemy="alchemy",n.Loom="loom",n))(Se||{});const Ve=[{id:"craft_wooden_plank",name:"Wooden Plank",description:"Process wood into planks",inputs:[{resourceId:"wood",quantity:1,consumed:!0}],outputs:[{resourceId:"wooden_plank",quantity:4}],craftTime:2,requiredStation:"hand"},{id:"craft_rope",name:"Rope",description:"Weave fibers into rope",inputs:[{resourceId:"fiber",quantity:5,consumed:!0}],outputs:[{resourceId:"rope",quantity:1}],craftTime:3,requiredStation:"hand"},{id:"craft_bandage",name:"Bandage",description:"Create a simple bandage",inputs:[{resourceId:"cloth",quantity:2,consumed:!0}],outputs:[{resourceId:"bandage",quantity:1}],craftTime:2,requiredStation:"hand"},{id:"craft_wooden_sword",name:"Wooden Sword",description:"Carve a basic wooden sword",inputs:[{resourceId:"wood",quantity:3,consumed:!0},{resourceId:"fiber",quantity:2,consumed:!0}],outputs:[{resourceId:"wooden_sword",quantity:1}],craftTime:5,requiredStation:"hand"},{id:"craft_arrow",name:"Arrows",description:"Craft a bundle of arrows",inputs:[{resourceId:"wood",quantity:1,consumed:!0},{resourceId:"stone",quantity:1,consumed:!0},{resourceId:"fiber",quantity:1,consumed:!0}],outputs:[{resourceId:"arrow",quantity:10}],craftTime:4,requiredStation:"hand"},{id:"craft_stone_pickaxe",name:"Stone Pickaxe",description:"Craft a stone mining tool",inputs:[{resourceId:"wood",quantity:2,consumed:!0},{resourceId:"stone",quantity:3,consumed:!0},{resourceId:"fiber",quantity:2,consumed:!0}],outputs:[{resourceId:"stone_pickaxe",quantity:1}],craftTime:5,requiredStation:"workbench"},{id:"craft_stone_axe",name:"Stone Axe",description:"Craft a stone woodcutting tool",inputs:[{resourceId:"wood",quantity:2,consumed:!0},{resourceId:"stone",quantity:3,consumed:!0},{resourceId:"fiber",quantity:2,consumed:!0}],outputs:[{resourceId:"stone_axe",quantity:1}],craftTime:5,requiredStation:"workbench"},{id:"craft_stone_sword",name:"Stone Sword",description:"Craft a stone blade",inputs:[{resourceId:"wood",quantity:1,consumed:!0},{resourceId:"stone",quantity:4,consumed:!0},{resourceId:"fiber",quantity:2,consumed:!0}],outputs:[{resourceId:"stone_sword",quantity:1}],craftTime:6,requiredStation:"workbench"},{id:"craft_bow",name:"Wooden Bow",description:"Craft a hunting bow",inputs:[{resourceId:"wood",quantity:3,consumed:!0},{resourceId:"fiber",quantity:5,consumed:!0}],outputs:[{resourceId:"bow",quantity:1}],craftTime:8,requiredStation:"workbench"},{id:"craft_stone_brick",name:"Stone Bricks",description:"Cut stone into building bricks",inputs:[{resourceId:"stone",quantity:2,consumed:!0}],outputs:[{resourceId:"stone_brick",quantity:4}],craftTime:4,requiredStation:"workbench"},{id:"smelt_iron",name:"Iron Ingot",description:"Smelt iron ore into an ingot",inputs:[{resourceId:"iron_ore",quantity:2,consumed:!0},{resourceId:"coal",quantity:1,consumed:!0}],outputs:[{resourceId:"iron_ingot",quantity:1}],craftTime:10,requiredStation:"furnace"},{id:"smelt_copper",name:"Copper Ingot",description:"Smelt copper ore into an ingot",inputs:[{resourceId:"copper_ore",quantity:2,consumed:!0},{resourceId:"coal",quantity:1,consumed:!0}],outputs:[{resourceId:"copper_ingot",quantity:1}],craftTime:8,requiredStation:"furnace"},{id:"smelt_gold",name:"Gold Ingot",description:"Smelt gold ore into an ingot",inputs:[{resourceId:"gold_ore",quantity:2,consumed:!0},{resourceId:"coal",quantity:1,consumed:!0}],outputs:[{resourceId:"gold_ingot",quantity:1}],craftTime:12,requiredStation:"furnace"},{id:"cook_meat",name:"Cooked Meat",description:"Cook raw meat",inputs:[{resourceId:"raw_meat",quantity:1,consumed:!0},{resourceId:"coal",quantity:1,consumed:!0}],outputs:[{resourceId:"cooked_meat",quantity:1}],craftTime:5,requiredStation:"furnace"},{id:"bake_bread",name:"Bread",description:"Bake bread from fiber (wheat)",inputs:[{resourceId:"fiber",quantity:3,consumed:!0},{resourceId:"coal",quantity:1,consumed:!0}],outputs:[{resourceId:"bread",quantity:1}],craftTime:6,requiredStation:"furnace"},{id:"craft_iron_pickaxe",name:"Iron Pickaxe",description:"Forge an iron mining tool",inputs:[{resourceId:"iron_ingot",quantity:3,consumed:!0},{resourceId:"wood",quantity:2,consumed:!0}],outputs:[{resourceId:"iron_pickaxe",quantity:1}],craftTime:10,requiredStation:"anvil"},{id:"craft_iron_axe",name:"Iron Axe",description:"Forge an iron woodcutting tool",inputs:[{resourceId:"iron_ingot",quantity:3,consumed:!0},{resourceId:"wood",quantity:2,consumed:!0}],outputs:[{resourceId:"iron_axe",quantity:1}],craftTime:10,requiredStation:"anvil"},{id:"craft_iron_sword",name:"Iron Sword",description:"Forge an iron blade",inputs:[{resourceId:"iron_ingot",quantity:4,consumed:!0},{resourceId:"wood",quantity:1,consumed:!0},{resourceId:"leather",quantity:1,consumed:!0}],outputs:[{resourceId:"iron_sword",quantity:1}],craftTime:12,requiredStation:"anvil"},{id:"craft_cloth",name:"Cloth",description:"Weave fibers into cloth",inputs:[{resourceId:"fiber",quantity:4,consumed:!0}],outputs:[{resourceId:"cloth",quantity:1}],craftTime:5,requiredStation:"loom"},{id:"brew_health_potion",name:"Health Potion",description:"Brew a healing potion",inputs:[{resourceId:"mushroom",quantity:3,consumed:!0},{resourceId:"berries",quantity:2,consumed:!0},{resourceId:"monster_essence",quantity:1,consumed:!0}],outputs:[{resourceId:"health_potion",quantity:1}],craftTime:15,requiredStation:"alchemy"}];class ve{recipes=new Map;activeCrafts=new Map;constructor(){for(const e of Ve)this.registerRecipe(e)}registerRecipe(e){this.recipes.set(e.id,e)}getRecipe(e){return this.recipes.get(e)}getAllRecipes(){return Array.from(this.recipes.values())}getRecipesForStation(e){return this.getAllRecipes().filter(t=>t.requiredStation===e)}getRecipeCount(){return this.recipes.size}canCraft(e,t,i="hand"){const s=this.getRecipe(e);if(!s||s.requiredStation!=="hand"&&s.requiredStation!==i)return!1;for(const o of s.inputs)if(!t.hasItem(o.resourceId,o.quantity))return!1;for(const o of s.outputs)if(!t.hasSpace(o.resourceId,o.quantity))return!1;return!0}getMissingIngredients(e,t){const i=this.getRecipe(e);if(!i)return[];const s=[];for(const o of i.inputs){const a=t.getItemCount(o.resourceId);a<o.quantity&&s.push({resourceId:o.resourceId,have:a,need:o.quantity})}return s}startCraft(e,t,i="hand"){const s=this.getRecipe(e);if(!s)return null;for(const a of s.inputs)a.consumed&&t.removeItem(a.resourceId,a.quantity);const o=`${e}_${Date.now()}`;return this.activeCrafts.set(o,{recipe:s,startTime:Date.now(),stationId:i}),o}isCraftComplete(e){const t=this.activeCrafts.get(e);return t?(Date.now()-t.startTime)/1e3>=t.recipe.craftTime:!1}getCraftProgress(e){const t=this.activeCrafts.get(e);if(!t)return 0;const i=(Date.now()-t.startTime)/1e3;return Math.min(1,i/t.recipe.craftTime)}completeCraft(e,t){const i=this.activeCrafts.get(e);if(!i||!this.isCraftComplete(e))return!1;for(const s of i.recipe.outputs)t.addItem(s.resourceId,s.quantity);return this.activeCrafts.delete(e),!0}cancelCraft(e){return this.activeCrafts.delete(e)}instantCraft(e,t,i="hand"){if(!this.canCraft(e,t,i))return!1;const s=this.getRecipe(e);for(const o of s.inputs)o.consumed&&t.removeItem(o.resourceId,o.quantity);for(const o of s.outputs)t.addItem(o.resourceId,o.quantity);return!0}getCraftableRecipes(e,t="hand"){return this.getAllRecipes().filter(i=>this.canCraft(i.id,e,t))}}let V=null;function je(){return V||(V=new ve),V}const Ke={maxHealth:100,maxHunger:100,maxStamina:100,hungerDecayRate:2,staminaRegenRate:10,hungerCritical:20,staminaCritical:10,hungerHealthDrain:1,hungerSpeedPenalty:.5,sprintStaminaCost:15,attackStaminaCost:10,mineStaminaCost:5};class we{name="SurvivalManager";config;health;hunger;stamina;isResting=!1;isSprinting=!1;isDead=!1;hungerAccumulator=0;constructor(e={}){this.config={...Ke,...e},this.health=this.config.maxHealth,this.hunger=this.config.maxHunger,this.stamina=this.config.maxStamina}initialize(){const e=h();e.on("input:actionPressed",t=>{t.action==="sprint"&&(this.isSprinting=!0)}),e.on("input:actionReleased",t=>{t.action==="sprint"&&(this.isSprinting=!1)}),console.log("[SurvivalManager] Initialized")}update(e,t){this.isDead||(this.updateHunger(e,t),this.updateStamina(e),this.applyCriticalEffects(e))}updateHunger(e,t){const i=.016666666666666666;if(this.hungerAccumulator+=e*i*this.config.hungerDecayRate,this.hungerAccumulator>=1){const s=Math.floor(this.hungerAccumulator);this.hunger=Math.max(0,this.hunger-s),this.hungerAccumulator-=s}}updateStamina(e){if(this.isSprinting&&this.stamina>0)this.stamina=Math.max(0,this.stamina-this.config.sprintStaminaCost*e);else if(!this.isSprinting&&this.stamina<this.config.maxStamina){const t=this.isHungryCritical()?.5:1;this.stamina=Math.min(this.config.maxStamina,this.stamina+this.config.staminaRegenRate*e*t)}}applyCriticalEffects(e){this.isHungryCritical()&&this.takeDamage(this.config.hungerHealthDrain*e,"starvation")}getHealth(){return this.health}getMaxHealth(){return this.config.maxHealth}takeDamage(e,t="unknown"){if(this.isDead)return;this.health=Math.max(0,this.health-e),h().emit("entity:damaged",{entityId:"player",amount:e,sourceId:t}),this.health<=0&&this.die()}heal(e){if(this.isDead)return;const t=this.health;this.health=Math.min(this.config.maxHealth,this.health+e);const i=this.health-t;i>0&&h().emit("entity:healed",{entityId:"player",amount:i})}isPlayerDead(){return this.isDead}die(){this.isDead=!0,h().emit("entity:died",{entityId:"player",killerId:null})}respawn(){this.health=this.config.maxHealth,this.hunger=this.config.maxHunger,this.stamina=this.config.maxStamina,this.isDead=!1,this.hungerAccumulator=0}getHunger(){return this.hunger}getMaxHunger(){return this.config.maxHunger}isHungryCritical(){return this.hunger<=this.config.hungerCritical}restoreHunger(e){this.hunger=Math.min(this.config.maxHunger,this.hunger+e)}getSpeedMultiplier(){return this.isHungryCritical()?this.config.hungerSpeedPenalty:1}getStamina(){return this.stamina}getMaxStamina(){return this.config.maxStamina}isStaminaCritical(){return this.stamina<=this.config.staminaCritical}canSprint(){return this.stamina>this.config.staminaCritical}useStamina(e){return this.stamina<e?!1:(this.stamina-=e,!0)}useAttackStamina(){return this.useStamina(this.config.attackStaminaCost)}useMineStamina(){return this.useStamina(this.config.mineStaminaCost)}consume(e){const t=_(),i=t.getResource(e);return!i||!t.isConsumable(e)?!1:(i.healAmount&&(i.healAmount>0?this.heal(i.healAmount):this.takeDamage(-i.healAmount,"food_poisoning")),i.hungerRestore&&this.restoreHunger(i.hungerRestore),!0)}getStats(){return{health:this.health,maxHealth:this.config.maxHealth,hunger:this.hunger,maxHunger:this.config.maxHunger,stamina:this.stamina,maxStamina:this.config.maxStamina}}setStats(e){e.health!==void 0&&(this.health=e.health),e.hunger!==void 0&&(this.hunger=e.hunger),e.stamina!==void 0&&(this.stamina=e.stamina)}destroy(){console.log("[SurvivalManager] Destroyed")}}let j=null;function Xe(){return j||(j=new we),j}class be{name="UIManager";state={activePanels:new Set([E.HUD]),modalStack:[],tooltipContent:null,tooltipPosition:null};panelRenderers=new Map;updateCallbacks=new Set;initialize(){const e=h();e.on("ui:tooltipShow",t=>{this.showTooltip(t.content,t.position)}),e.on("ui:tooltipHide",()=>{this.hideTooltip()}),console.log("[UIManager] Initialized")}update(e,t){for(const i of this.updateCallbacks)i(this.state)}openPanel(e,t=!1){if(this.isPanelOpen(e))return;this.state.activePanels.add(e),t&&this.state.modalStack.push(e),h().emit("ui:panelOpened",{panel:e})}closePanel(e){if(!this.isPanelOpen(e))return;this.state.activePanels.delete(e);const t=this.state.modalStack.indexOf(e);t!==-1&&this.state.modalStack.splice(t,1),h().emit("ui:panelClosed",{panel:e})}togglePanel(e,t=!1){this.isPanelOpen(e)?this.closePanel(e):this.openPanel(e,t)}isPanelOpen(e){return this.state.activePanels.has(e)}closeTopModal(){if(this.state.modalStack.length===0)return!1;const e=this.state.modalStack.pop();return this.state.activePanels.delete(e),h().emit("ui:panelClosed",{panel:e}),!0}closeAllModals(){for(;this.closeTopModal(););}getTopModal(){return this.state.modalStack.length===0?null:this.state.modalStack[this.state.modalStack.length-1]}hasOpenModal(){return this.state.modalStack.length>0}showTooltip(e,t){this.state.tooltipContent=e,this.state.tooltipPosition={...t}}hideTooltip(){this.state.tooltipContent=null,this.state.tooltipPosition=null}isTooltipVisible(){return this.state.tooltipContent!==null}getTooltipContent(){return this.state.tooltipContent}getTooltipPosition(){return this.state.tooltipPosition}registerPanelRenderer(e,t){this.panelRenderers.set(e,t)}unregisterPanelRenderer(e){this.panelRenderers.delete(e)}onUpdate(e){return this.updateCallbacks.add(e),()=>this.updateCallbacks.delete(e)}getActivePanels(){return this.state.activePanels}getModalStack(){return this.state.modalStack}getState(){return this.state}destroy(){this.state.activePanels.clear(),this.state.modalStack=[],this.panelRenderers.clear(),this.updateCallbacks.clear(),console.log("[UIManager] Destroyed")}}async function ke(){const n=Y(),e=new me,t=new Z,i=new te,s=new ie,o=new le,a=new de,r=new he,c=new be;return i.setTilemapManager(t),o.setWalkableCheck((u,d)=>t.isWalkable(u,d)),e.setScreenToWorldConverter((u,d)=>a.screenToWorld(u,d,800,600)),n.registerSystem(e,0),n.registerSystem(t,1),n.registerSystem(i,2),n.registerSystem(s,3),n.registerSystem(o,4),n.registerSystem(a,5),n.registerSystem(r,6),n.registerSystem(c,7),await n.initialize(),n}async function Qe(){console.log("Starting 2D RPG Game...");const n=await ke(),e=n.getSystem("TilemapManager"),t=n.getSystem("PlayerController"),i=n.getSystem("CameraSystem");if(e){for(let s=-10;s<=10;s++)for(let o=-10;o<=10;o++)e.setTile(s,o,1,"grass");e.setTile(5,5,2,"tree"),e.setTile(-3,2,2,"tree"),e.setTile(7,-4,2,"tree"),e.setTile(-5,-5,2,"rock"),e.setTile(3,-7,2,"rock")}t&&t.setPosition(0,0),i&&i.snapTo(0,0),n.start(),console.log("Game started! Use WASD to move.")}l.AutotileSystem=te,l.BiomeManager=ae,l.BiomeType=L,l.CameraSystem=de,l.CraftingManager=ve,l.CraftingStation=Se,l.Direction=w,l.EntityType=X,l.EventBus=k,l.GameEngine=M,l.GamepadAxis=C,l.GamepadButton=v,l.InputAction=Q,l.InputManager=me,l.InventoryManager=ye,l.NOISE_CONFIGS=D,l.Neighbor4=J,l.Neighbor8=ee,l.NoiseGenerator=ne,l.PanelType=E,l.PlayerController=le,l.PlayerState=ue,l.RegionManager=ie,l.ResourceCategory=pe,l.ResourceManager=fe,l.SaveManager=he,l.SurvivalManager=we,l.TileLayer=p,l.TileRegistry=x,l.TilemapManager=Z,l.UIManager=be,l.WorldGenerator=ce,l.getBiomeManager=re,l.getCraftingManager=je,l.getEventBus=h,l.getGameEngine=Y,l.getInventoryManager=$e,l.getResourceManager=_,l.getSurvivalManager=Xe,l.getTileRegistry=A,l.getWorldGenerator=We,l.initializeGame=ke,l.quickStart=Qe,l.resetWorldGenerator=Ge,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=voxel-rpg.umd.js.map
